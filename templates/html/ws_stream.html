<!DOCTYPE html>
<html>
<head>
    <title>WebSocket MP4 Stream</title>
</head>
<body>
    <h1>WebSocket MP4 Stream</h1>
    <video id="videoPlayer" controls width="640" height="360"></video>

    <script>
        const video = document.getElementById('videoPlayer');
        const mediaSource = new MediaSource();
        video.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener('sourceopen', () => {
            const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
            const ws = new WebSocket('ws://localhost:9002');
            ws.binaryType = 'arraybuffer';

            ws.onmessage = (event) => {
                const data = new Uint8Array(event.data);
                if (sourceBuffer.updating || queue.length > 0) {
                    queue.push(data);
                } else {
                    sourceBuffer.appendBuffer(data);
                }
            };

            const queue = [];
            sourceBuffer.addEventListener('updateend', () => {
                if (queue.length > 0 && !sourceBuffer.updating) {
                    sourceBuffer.appendBuffer(queue.shift());
                }
            });

            ws.onopen = () => {
                console.log('Connected to WebSocket server');
            };

            ws.onclose = () => {
                console.log('Disconnected from WebSocket server');
                if (!sourceBuffer.updating) {
                    // mediaSource.endOfStream();
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        });
    </script>
</body>
</html>
